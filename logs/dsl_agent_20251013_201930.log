2025-10-13 20:19:30,442 [INFO] DSLAgent: Logging to: /home/lee/canvas-with-langgraph-python/logs/dsl_agent_20251013_201930.log
2025-10-13 20:20:56,553 [INFO] DSLAgent: === DECLARATION NODE START ===
2025-10-13 20:20:56,553 [INFO] DSLAgent: Initial state: {'yaml_path': 'bang!.yaml', 'game_description': 'A Wild West shootout card game where players have hidden roles and use playing cards to attack, defend, and survive. The Sheriff (revealed) must eliminate Outlaws and the Renegade. Deputies protect the Sheriff. Outlaws try to kill the Sheriff. The Renegade wants to be the last one standing. Players sit in a circle with distance determining who can be targeted by various cards.\\n\\nGame Flow Navigation: game_setup → role_assignment → character_assignment → initial_setup → turn_start → draw_phase → play_phase → (reaction windows for cards like Bang!/Missed!) → damage_resolution → discard_phase → elimination_check → (check win conditions) → turn_start OR game_over. Each turn consists of drawing 2 cards and playing cards from hand.\\n\\nRole Victory Conditions: Sheriff wins if all Outlaws and Renegade eliminated. Outlaws win if Sheriff eliminated (even if they\'re dead). Deputies win if Sheriff wins. Renegade wins if they\'re the last player alive. Sheriff is always revealed, other roles stay hidden until eliminated.\\n\\nDistance and Range: Players sit in a circle. Distance = shortest path between players (clockwise or counter-clockwise). Base range for Bang! is 1 (adjacent players only). Weapons increase Bang! range. Some cards (Panic!, Cat Balou) have fixed range 1. Distance affects strategic positioning and alliances.\\n\\nCard Types: Playing cards include Bang! (attack), Missed! (defense), Beer (heal), Panic!/Cat Balou (steal/discard), Duel (force showdown), Indians!/Gatling (area attacks), Weapons (increase range), and other equipment. Each character has unique abilities that modify rules (e.g., Rose Doolan sees everyone at distance -1).\\n\\nReaction System: When attacked with Bang!, target can play Missed! to avoid damage. Indians! requires all players to discard Bang! or take damage. Duel creates Bang! exchanges until someone can\'t respond. Real-time reaction windows use collectInputs with timeouts."'}
2025-10-13 20:20:56,554 [INFO] DSLAgent: Game description: A Wild West shootout card game where players have hidden roles and use playing cards to attack, defe...
2025-10-13 20:21:56,556 [INFO] DSLAgent: Extracted YAML text length: 6306
2025-10-13 20:21:56,563 [INFO] DSLAgent: Parsed declaration object keys: ['declaration']
2025-10-13 20:21:56,563 [INFO] DSLAgent: Target file path: /home/lee/canvas-with-langgraph-python/games/bang!.yaml
2025-10-13 20:21:56,563 [INFO] DSLAgent: Writing declaration to file. Output keys: ['declaration']
2025-10-13 20:21:56,567 [INFO] DSLAgent: Verification - file content length after write: 6731
2025-10-13 20:21:56,567 [INFO] DSLAgent: === DECLARATION NODE END ===
2025-10-13 20:21:56,569 [INFO] DSLAgent: === PHASES NODE START ===
2025-10-13 20:21:56,569 [INFO] DSLAgent: State received: {'yaml_path': '/home/lee/canvas-with-langgraph-python/games/bang!.yaml', 'dsl': {'declaration': {'description': 'A Wild West shootout card game of hidden roles, distance, and reaction windows. The Sheriff (revealed) must eliminate Outlaws and the Renegade; Deputies protect the Sheriff; Outlaws win if the Sheriff dies; the Renegade aims to be the last alive. Players sit in a circle where distance governs targeting and card ranges. Each turn: draw 2, play cards, react (e.g., "Bang!"/"Missed!", "Indians!", "Duel"), resolve damage, discard, check elimination and win conditions.', 'is_multiplayer': True, 'roles': [{'name': 'Sheriff', 'description': 'Revealed role. Victory: eliminate all Outlaws and the Renegade. Starts with +1 maximum health compared to others.'}, {'name': 'Deputy', 'description': 'Hidden role. Victory: same as Sheriff; wins if the Sheriff wins by surviving the Outlaws and Renegade.'}, {'name': 'Outlaw', 'description': 'Hidden role. Victory: eliminate the Sheriff (Outlaws still win if the Sheriff dies even if some Outlaws are already eliminated).'}, {'name': 'Renegade', 'description': 'Hidden role. Victory: be the last player alive (typically wants the Sheriff to be eliminated last).'}], 'player_states': {'name': {'type': 'string', 'example': 'Player A', 'description': 'Display name used in prompts, turn order announcements, and logs.'}, 'role': {'type': 'string', 'example': 'Sheriff', 'description': 'Hidden identity (except Sheriff) determining victory condition: Sheriff, Deputy, Outlaw, or Renegade.'}, 'role_revealed': {'type': 'boolean', 'example': True, 'description': "Whether this player's role is publicly revealed (Sheriff starts revealed; others reveal upon elimination or via effects)."}, 'character': {'type': 'string', 'example': 'Rose Doolan', 'description': 'Unique character that modifies rules (e.g., range/distance adjustments, extra draws, special reactions).'}, 'is_alive': {'type': 'boolean', 'example': True, 'description': 'Whether the player is still in the game. Eliminated players take no further turns or reactions.'}, 'health': {'type': 'num', 'example': 4, 'description': 'Current life points. Reaching 0 triggers elimination unless immediately healed (e.g., "Beer" if allowed).'}, 'max_health': {'type': 'num', 'example': 5, 'description': 'Maximum life points. Sheriff typically has +1 compared to others; characters may also modify this.'}, 'hand': {'type': 'dict', 'example': {'Bang!': 2, 'Missed!': 1, 'Beer': 1}, 'description': 'Cards in hand as counts by name. Played, discarded, or reacted from here.'}, 'equipment': {'type': 'dict', 'example': {'weapon': 'Schofield', 'barrel': '', 'scope': '', 'mustang': '', 'jail': '', 'dynamite': ''}, 'description': 'In-play cards occupying slots. Weapons set shooting range; Barrel/Scope/Mustang modify reactions and distance; Jail/Dynamite have special timers/effects.'}, 'seat_position': {'type': 'num', 'example': 1, 'description': "Player's seat index around the table (clockwise order) used to compute circular distances."}, 'distance_to_others': {'type': 'dict', 'example': {2: 1, 3: 2, 4: 1}, 'description': 'Computed shortest-path distances to other players by seat order. Affects targeting for "Bang!", "Panic!", "Cat Balou", etc.'}, 'range_bonus': {'type': 'num', 'example': 1, 'description': 'Total bonus added to base shooting range (1) from weapon and abilities (e.g., Scope, character effects).'}, 'range_penalty_to_others': {'type': 'num', 'example': 0, 'description': 'Amount by which others perceive this player at increased distance (e.g., +1 from Mustang).'}, 'bang_limit_used': {'type': 'boolean', 'example': False, 'description': 'Whether the once-per-turn "Bang!" usage (without special weapon like Volcanic) has been consumed.'}, 'pending_reaction': {'type': 'dict', 'example': {'window': 'defense', 'requested_card': 'Missed!'}, 'description': 'Active reaction window state for this player (e.g., to respond with "Missed!", or to a "Duel"/"Indians!"). Empty if none.'}}, 'players_example': {'players': {1: {'name': 'Sheriff Sam', 'role': 'Sheriff', 'role_revealed': True, 'character': 'Bart Cassidy', 'is_alive': True, 'health': 5, 'max_health': 5, 'hand': {'Bang!': 2, 'Missed!': 1, 'Beer': 1}, 'equipment': {'weapon': 'Schofield', 'barrel': '', 'scope': '', 'mustang': '', 'jail': '', 'dynamite': ''}, 'seat_position': 1, 'distance_to_others': {2: 1, 3: 2, 4: 1}, 'range_bonus': 1, 'range_penalty_to_others': 0, 'bang_limit_used': False, 'pending_reaction': {}}, 2: {'name': 'Deputy Daisy', 'role': 'Deputy', 'role_revealed': False, 'character': 'Rose Doolan', 'is_alive': True, 'health': 4, 'max_health': 4, 'hand': {'Bang!': 1, 'Missed!': 1, 'Panic!': 1}, 'equipment': {'weapon': 'Volcanic', 'barrel': '', 'scope': '', 'mustang': '', 'jail': '', 'dynamite': ''}, 'seat_position': 2, 'distance_to_others': {1: 1, 3: 1, 4: 2}, 'range_bonus': 1, 'range_penalty_to_others': 0, 'bang_limit_used': False, 'pending_reaction': {}}, 3: {'name': 'Outlaw Ollie', 'role': 'Outlaw', 'role_revealed': False, 'character': 'Willy the Kid', 'is_alive': True, 'health': 3, 'max_health': 4, 'hand': {'Bang!': 1, 'Duel': 1, 'Cat Balou': 1}, 'equipment': {'weapon': 'Remington', 'barrel': '', 'scope': '', 'mustang': '', 'jail': '', 'dynamite': ''}, 'seat_position': 3, 'distance_to_others': {1: 2, 2: 1, 4: 1}, 'range_bonus': 2, 'range_penalty_to_others': 0, 'bang_limit_used': False, 'pending_reaction': {}}, 4: {'name': 'Renegade Rex', 'role': 'Renegade', 'role_revealed': False, 'character': 'Calamity Janet', 'is_alive': True, 'health': 4, 'max_health': 4, 'hand': {'Bang!': 1, 'Missed!': 2, 'Beer': 1}, 'equipment': {'weapon': 'Schofield', 'barrel': '', 'scope': '', 'mustang': 'Mustang', 'jail': '', 'dynamite': ''}, 'seat_position': 4, 'distance_to_others': {1: 1, 2: 2, 3: 1}, 'range_bonus': 1, 'range_penalty_to_others': 1, 'bang_limit_used': False, 'pending_reaction': {}}}}}}, 'game_description': 'A Wild West shootout card game where players have hidden roles and use playing cards to attack, defend, and survive. The Sheriff (revealed) must eliminate Outlaws and the Renegade. Deputies protect the Sheriff. Outlaws try to kill the Sheriff. The Renegade wants to be the last one standing. Players sit in a circle with distance determining who can be targeted by various cards.\\n\\nGame Flow Navigation: game_setup → role_assignment → character_assignment → initial_setup → turn_start → draw_phase → play_phase → (reaction windows for cards like Bang!/Missed!) → damage_resolution → discard_phase → elimination_check → (check win conditions) → turn_start OR game_over. Each turn consists of drawing 2 cards and playing cards from hand.\\n\\nRole Victory Conditions: Sheriff wins if all Outlaws and Renegade eliminated. Outlaws win if Sheriff eliminated (even if they\'re dead). Deputies win if Sheriff wins. Renegade wins if they\'re the last player alive. Sheriff is always revealed, other roles stay hidden until eliminated.\\n\\nDistance and Range: Players sit in a circle. Distance = shortest path between players (clockwise or counter-clockwise). Base range for Bang! is 1 (adjacent players only). Weapons increase Bang! range. Some cards (Panic!, Cat Balou) have fixed range 1. Distance affects strategic positioning and alliances.\\n\\nCard Types: Playing cards include Bang! (attack), Missed! (defense), Beer (heal), Panic!/Cat Balou (steal/discard), Duel (force showdown), Indians!/Gatling (area attacks), Weapons (increase range), and other equipment. Each character has unique abilities that modify rules (e.g., Rose Doolan sees everyone at distance -1).\\n\\nReaction System: When attacked with Bang!, target can play Missed! to avoid damage. Indians! requires all players to discard Bang! or take damage. Duel creates Bang! exchanges until someone can\'t respond. Real-time reaction windows use collectInputs with timeouts."'}
2025-10-13 20:21:56,569 [INFO] DSLAgent: Reading from file path: /home/lee/canvas-with-langgraph-python/games/bang!.yaml
2025-10-13 20:21:56,569 [INFO] DSLAgent: File exists: True
2025-10-13 20:21:56,569 [INFO] DSLAgent: File content before processing (length: 6731):
2025-10-13 20:21:56,569 [INFO] DSLAgent: File content preview: declaration:
  description: 'A Wild West shootout card game of hidden roles, distance, and reaction
    windows. The Sheriff (revealed) must eliminate Outlaws and the Renegade; Deputies
    protect th...
2025-10-13 20:21:56,576 [INFO] DSLAgent: Existing YAML keys: ['declaration']
2025-10-13 20:21:56,577 [INFO] DSLAgent: Declaration found in existing file with keys: ['description', 'is_multiplayer', 'roles', 'player_states', 'players_example']
2025-10-13 20:21:56,581 [INFO] DSLAgent: Declaration block being sent to model (length: 6731):
2025-10-13 20:21:56,582 [INFO] DSLAgent: Declaration block preview: declaration:
  description: 'A Wild West shootout card game of hidden roles, distance, and reaction
    windows. The Sheriff (revealed) must eliminate Outlaws and the Renegade; Deputies
    protect th...
2025-10-13 20:25:59,743 [INFO] DSLAgent: Model response YAML length: 16060
2025-10-13 20:25:59,759 [INFO] DSLAgent: Parsed phases object keys: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 97, 98, 99]
2025-10-13 20:25:59,759 [INFO] DSLAgent: Before merge - existing keys: ['declaration']
2025-10-13 20:25:59,759 [INFO] DSLAgent: Added phases from root of phases_obj
2025-10-13 20:25:59,759 [INFO] DSLAgent: After merge - existing keys: ['declaration', 'phases']
2025-10-13 20:25:59,770 [INFO] DSLAgent: Final YAML to write (length: 23720):
2025-10-13 20:25:59,770 [INFO] DSLAgent: Final YAML preview: declaration:
  description: 'A Wild West shootout card game of hidden roles, distance, and reaction
    windows. The Sheriff (revealed) must eliminate Outlaws and the Renegade; Deputies
    protect th...
2025-10-13 20:25:59,771 [INFO] DSLAgent: Verification - file content after write (length: 23720):
2025-10-13 20:25:59,771 [INFO] DSLAgent: Verification preview: declaration:
  description: 'A Wild West shootout card game of hidden roles, distance, and reaction
    windows. The Sheriff (revealed) must eliminate Outlaws and the Renegade; Deputies
    protect th...
2025-10-13 20:25:59,771 [INFO] DSLAgent: === PHASES NODE END ===
2025-10-13 20:25:59,772 [INFO] DSLAgent: === VALIDATION NODE START ===
2025-10-13 20:25:59,772 [INFO] DSLAgent: State received: {'yaml_path': '/home/lee/canvas-with-langgraph-python/games/bang!.yaml', 'dsl': {'declaration': {'description': 'A Wild West shootout card game of hidden roles, distance, and reaction windows. The Sheriff (revealed) must eliminate Outlaws and the Renegade; Deputies protect the Sheriff; Outlaws win if the Sheriff dies; the Renegade aims to be the last alive. Players sit in a circle where distance governs targeting and card ranges. Each turn: draw 2, play cards, react (e.g., "Bang!"/"Missed!", "Indians!", "Duel"), resolve damage, discard, check elimination and win conditions.', 'is_multiplayer': True, 'roles': [{'name': 'Sheriff', 'description': 'Revealed role. Victory: eliminate all Outlaws and the Renegade. Starts with +1 maximum health compared to others.'}, {'name': 'Deputy', 'description': 'Hidden role. Victory: same as Sheriff; wins if the Sheriff wins by surviving the Outlaws and Renegade.'}, {'name': 'Outlaw', 'description': 'Hidden role. Victory: eliminate the Sheriff (Outlaws still win if the Sheriff dies even if some Outlaws are already eliminated).'}, {'name': 'Renegade', 'description': 'Hidden role. Victory: be the last player alive (typically wants the Sheriff to be eliminated last).'}], 'player_states': {'name': {'type': 'string', 'example': 'Player A', 'description': 'Display name used in prompts, turn order announcements, and logs.'}, 'role': {'type': 'string', 'example': 'Sheriff', 'description': 'Hidden identity (except Sheriff) determining victory condition: Sheriff, Deputy, Outlaw, or Renegade.'}, 'role_revealed': {'type': 'boolean', 'example': True, 'description': "Whether this player's role is publicly revealed (Sheriff starts revealed; others reveal upon elimination or via effects)."}, 'character': {'type': 'string', 'example': 'Rose Doolan', 'description': 'Unique character that modifies rules (e.g., range/distance adjustments, extra draws, special reactions).'}, 'is_alive': {'type': 'boolean', 'example': True, 'description': 'Whether the player is still in the game. Eliminated players take no further turns or reactions.'}, 'health': {'type': 'num', 'example': 4, 'description': 'Current life points. Reaching 0 triggers elimination unless immediately healed (e.g., "Beer" if allowed).'}, 'max_health': {'type': 'num', 'example': 5, 'description': 'Maximum life points. Sheriff typically has +1 compared to others; characters may also modify this.'}, 'hand': {'type': 'dict', 'example': {'Bang!': 2, 'Missed!': 1, 'Beer': 1}, 'description': 'Cards in hand as counts by name. Played, discarded, or reacted from here.'}, 'equipment': {'type': 'dict', 'example': {'weapon': 'Schofield', 'barrel': '', 'scope': '', 'mustang': '', 'jail': '', 'dynamite': ''}, 'description': 'In-play cards occupying slots. Weapons set shooting range; Barrel/Scope/Mustang modify reactions and distance; Jail/Dynamite have special timers/effects.'}, 'seat_position': {'type': 'num', 'example': 1, 'description': "Player's seat index around the table (clockwise order) used to compute circular distances."}, 'distance_to_others': {'type': 'dict', 'example': {2: 1, 3: 2, 4: 1}, 'description': 'Computed shortest-path distances to other players by seat order. Affects targeting for "Bang!", "Panic!", "Cat Balou", etc.'}, 'range_bonus': {'type': 'num', 'example': 1, 'description': 'Total bonus added to base shooting range (1) from weapon and abilities (e.g., Scope, character effects).'}, 'range_penalty_to_others': {'type': 'num', 'example': 0, 'description': 'Amount by which others perceive this player at increased distance (e.g., +1 from Mustang).'}, 'bang_limit_used': {'type': 'boolean', 'example': False, 'description': 'Whether the once-per-turn "Bang!" usage (without special weapon like Volcanic) has been consumed.'}, 'pending_reaction': {'type': 'dict', 'example': {'window': 'defense', 'requested_card': 'Missed!'}, 'description': 'Active reaction window state for this player (e.g., to respond with "Missed!", or to a "Duel"/"Indians!"). Empty if none.'}}, 'players_example': {'players': {1: {'name': 'Sheriff Sam', 'role': 'Sheriff', 'role_revealed': True, 'character': 'Bart Cassidy', 'is_alive': True, 'health': 5, 'max_health': 5, 'hand': {'Bang!': 2, 'Missed!': 1, 'Beer': 1}, 'equipment': {'weapon': 'Schofield', 'barrel': '', 'scope': '', 'mustang': '', 'jail': '', 'dynamite': ''}, 'seat_position': 1, 'distance_to_others': {2: 1, 3: 2, 4: 1}, 'range_bonus': 1, 'range_penalty_to_others': 0, 'bang_limit_used': False, 'pending_reaction': {}}, 2: {'name': 'Deputy Daisy', 'role': 'Deputy', 'role_revealed': False, 'character': 'Rose Doolan', 'is_alive': True, 'health': 4, 'max_health': 4, 'hand': {'Bang!': 1, 'Missed!': 1, 'Panic!': 1}, 'equipment': {'weapon': 'Volcanic', 'barrel': '', 'scope': '', 'mustang': '', 'jail': '', 'dynamite': ''}, 'seat_position': 2, 'distance_to_others': {1: 1, 3: 1, 4: 2}, 'range_bonus': 1, 'range_penalty_to_others': 0, 'bang_limit_used': False, 'pending_reaction': {}}, 3: {'name': 'Outlaw Ollie', 'role': 'Outlaw', 'role_revealed': False, 'character': 'Willy the Kid', 'is_alive': True, 'health': 3, 'max_health': 4, 'hand': {'Bang!': 1, 'Duel': 1, 'Cat Balou': 1}, 'equipment': {'weapon': 'Remington', 'barrel': '', 'scope': '', 'mustang': '', 'jail': '', 'dynamite': ''}, 'seat_position': 3, 'distance_to_others': {1: 2, 2: 1, 4: 1}, 'range_bonus': 2, 'range_penalty_to_others': 0, 'bang_limit_used': False, 'pending_reaction': {}}, 4: {'name': 'Renegade Rex', 'role': 'Renegade', 'role_revealed': False, 'character': 'Calamity Janet', 'is_alive': True, 'health': 4, 'max_health': 4, 'hand': {'Bang!': 1, 'Missed!': 2, 'Beer': 1}, 'equipment': {'weapon': 'Schofield', 'barrel': '', 'scope': '', 'mustang': 'Mustang', 'jail': '', 'dynamite': ''}, 'seat_position': 4, 'distance_to_others': {1: 1, 2: 2, 3: 1}, 'range_bonus': 1, 'range_penalty_to_others': 1, 'bang_limit_used': False, 'pending_reaction': {}}}}}, 'phases': {0: {'name': 'Game Introduction', 'description': "Introduce the game's Western shootout theme, objectives for each role (Sheriff/Deputy, Outlaw, Renegade), turn structure (draw 2, play cards, reactions, discard), targeting by distance, and elimination/win rules.", 'actions': [{'description': 'Clear any previous UI and display game rules, objectives, and turn structure', 'tools': ['clear_ui', 'display_game_intro']}, {'description': 'Show player list, explain revealed Sheriff concept, hidden roles, characters, and distance-based targeting', 'tools': ['display_player_setup']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Game introduction has been displayed to all players.'}, 'next_phase': {'id': 1, 'name': 'Role Assignment'}}, 1: {'name': 'Role Assignment', 'description': 'Randomly assign roles to players (Sheriff revealed; others hidden) according to player count and game configuration.', 'actions': [{'description': 'Clear UI and assign roles randomly based on player count distribution (Sheriff, Deputies, Outlaws, Renegade)', 'tools': ['clear_ui', 'assign_roles_randomly']}, {'description': 'Reveal the Sheriff to everyone; keep other roles hidden', 'tools': ['reveal_sheriff_publicly', 'keep_other_roles_hidden']}, {'description': 'Privately notify each player of their role and victory condition', 'tools': ['notify_player_roles']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'All roles have been assigned and players have been notified.'}, 'next_phase': {'id': 2, 'name': 'Seating, Characters, and Health Setup'}}, 2: {'name': 'Seating, Characters, and Health Setup', 'description': 'Seat players in a circle, assign characters, compute distances, and establish starting/max health (Sheriff +1; character modifiers).', 'actions': [{'description': 'Clear UI and set seat order clockwise; compute initial circular distances', 'tools': ['clear_ui', 'set_seat_order_clockwise', 'compute_distances']}, {'description': 'Assign characters randomly (or per config) and apply character-based modifiers', 'tools': ['assign_characters_randomly', 'apply_character_modifiers']}, {'description': 'Set max_health (Sheriff +1) and initialize current health to max', 'tools': ['apply_sheriff_bonus', 'set_initial_health_equal_to_max']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Seating, character assignment, and health setup completed.'}, 'next_phase': {'id': 3, 'name': 'Deal Starting Hands'}}, 3: {'name': 'Deal Starting Hands', 'description': 'Deal starting cards to each player equal to their current health; equip default weapon if none.', 'actions': [{'description': 'Clear UI and deal starting hands', 'tools': ['clear_ui', 'deal_starting_hands']}, {'description': 'Ensure default weapon (Colt .45) is equipped where applicable', 'tools': ['equip_default_weapon_if_empty']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Starting hands dealt and initial equipment set.'}, 'next_phase': {'id': 4, 'name': 'Start Turn — Announce Current Player'}}, 4: {'name': 'Start Turn — Announce Current Player', 'description': 'Advance to the next surviving player and announce their turn.', 'actions': [{'description': 'Clear UI, advance turn pointer to next alive player, and announce', 'tools': ['clear_ui', 'advance_turn_pointer', 'display_turn_banner']}], 'completion_criteria': {'type': 'UI_displayed', 'description': "Current player's turn announced."}, 'next_phase': {'id': 5, 'name': 'Start-of-Turn Effects'}}, 5: {'name': 'Start-of-Turn Effects', 'description': 'Resolve persistent effects on the current player (e.g., Dynamite, Jail) before drawing.', 'actions': [{'description': 'Clear UI and resolve Dynamite, Jail, and other start-of-turn checks; apply any damage and skip logic', 'tools': ['clear_ui', 'resolve_start_of_turn_effects']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Start-of-turn effects resolved.'}, 'next_phase': {'If the current player was eliminated during start-of-turn effects': {'id': 16, 'name': 'Resolve Eliminations and Rewards'}, "If the current player's turn is skipped due to effects (e.g., Jail)": {'id': 17, 'name': 'Check Win Conditions'}, 'Otherwise (player continues their turn)': {'id': 6, 'name': 'Draw Phase'}}}, 6: {'name': 'Draw Phase', 'description': 'The current player draws 2 cards.', 'actions': [{'description': 'Clear UI and draw 2 cards for the current player', 'tools': ['clear_ui', 'draw_cards']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Cards drawn for the current player.'}, 'next_phase': {'id': 7, 'name': 'Action Phase — Choose and Play a Card or End Turn'}}, 7: {'name': 'Action Phase — Choose and Play a Card or End Turn', 'description': 'Current player chooses a card to play (and targets if needed), or ends their action phase.', 'actions': [{'description': "Clear UI and present legal actions based on range, bang_limit, and card rules; allow card/target selection or 'End Turn'", 'tools': ['clear_ui', 'prompt_action_choice']}], 'completion_criteria': {'type': 'player_action', 'description': "Current player's action choice has been received, targets recorded if applicable, and relevant player state (player_states) has been updated.", 'wait_for': 'single_player_choice', 'target_players': {'description': 'The current player taking their turn', 'condition': 'player.id == state.current_player_id and player.is_alive == true'}}, 'next_phase': {"If the player chose a targeted attack (e.g., 'Bang!' or similar)": {'id': 8, 'name': 'Defense Reaction — Targeted Attack'}, "If the player chose 'Duel'": {'id': 9, 'name': 'Duel Exchange'}, "If the player chose a mass attack (e.g., 'Indians!', 'Gatling')": {'id': 10, 'name': 'Mass Reaction Window'}, 'If the player played a non-reactive card (e.g., equip, steal/discard effects)': {'id': 11, 'name': 'Resolve Non-Reactive Card'}, 'If the player ended their action phase': {'id': 14, 'name': 'Discard Phase'}}}, 8: {'name': 'Defense Reaction — Targeted Attack', 'description': "The targeted player may respond with valid defense (e.g., 'Missed!', character/equipment abilities); otherwise damage is applied.", 'actions': [{'description': 'Clear UI and prompt the defending player for available reactions; resolve automatic checks (e.g., Barrel) as needed', 'tools': ['clear_ui', 'prompt_defense_reaction', 'resolve_defense_result']}], 'completion_criteria': {'type': 'player_action', 'description': "Defender's reaction (if any) has been received/resolved, and relevant player state (player_states) has been updated.", 'wait_for': 'single_player_choice', 'target_players': {'description': 'The currently targeted defending player', 'condition': 'player.id == state.current_defender_id and player.is_alive == true'}}, 'next_phase': {'If the defense succeeded and no damage is dealt': {'id': 7, 'name': 'Action Phase — Choose and Play a Card or End Turn'}, 'If the defense failed or was not provided and damage should be applied': {'id': 12, 'name': 'Apply Damage and Downs (Targeted)'}}}, 9: {'name': 'Duel Exchange', 'description': "Resolve an ongoing Duel by alternating prompts; the current duelist must play 'Bang!' or concede and take damage.", 'actions': [{'description': "Clear UI and prompt the current duelist to play 'Bang!' or concede", 'tools': ['clear_ui', 'prompt_duelist_response']}], 'completion_criteria': {'type': 'player_action', 'description': "Current duelist's response has been received, and relevant player state (player_states) has been updated.", 'wait_for': 'single_player_choice', 'target_players': {'description': 'The player currently obligated to respond in the Duel', 'condition': 'player.id == state.current_duelist_id and player.is_alive == true'}}, 'next_phase': {"If the current duelist played 'Bang!' and the Duel continues to the opponent": {'id': 9, 'name': 'Duel Exchange'}, 'If a duelist failed to respond and must take damage': {'id': 12, 'name': 'Apply Damage and Downs (Targeted)'}}}, 10: {'name': 'Mass Reaction Window', 'description': "All other players may respond to a mass attack (e.g., 'Indians!', 'Gatling') as allowed; unresolved players will take damage.", 'actions': [{'description': 'Clear UI and present required/optional reactions to all affected players; collect responses', 'tools': ['clear_ui', 'prompt_mass_reactions']}], 'completion_criteria': {'type': 'player_action', 'description': 'Responses have been received from all required players, and relevant player state (player_states) has been updated.', 'wait_for': 'all_players_action', 'target_players': {'description': 'All surviving players affected by the mass attack (excluding the instigator)', 'condition': 'player.is_alive == true and player.id != state.current_player_id'}}, 'next_phase': {'id': 13, 'name': 'Apply Mass Damage and Downs'}}, 11: {'name': 'Resolve Non-Reactive Card', 'description': "Resolve effects of a non-reactive card (e.g., equipping weapon, 'Panic!'/'Cat Balou' resolution, movement/distance modifiers).", 'actions': [{'description': "Clear UI and apply the card's effect, updating hands/equipment/range/distance as appropriate", 'tools': ['clear_ui', 'resolve_card_effect', 'update_distances_if_needed']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Card effect resolved.'}, 'next_phase': {'id': 7, 'name': 'Action Phase — Choose and Play a Card or End Turn'}}, 12: {'name': 'Apply Damage and Downs (Targeted)', 'description': 'Apply damage from a targeted interaction (e.g., failed defense or Duel) and mark any players reduced to 0 health.', 'actions': [{'description': 'Clear UI and apply damage; mark players at 0 health as downed pending last-chance recovery', 'tools': ['clear_ui', 'apply_damage_and_mark_downs']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Damage applied and downed players identified.'}, 'next_phase': {"If any downed players are eligible for last-chance recovery (e.g., 'Beer')": {'id': 15, 'name': 'Last-Chance Recovery Reaction'}, 'Otherwise, proceed to elimination resolution': {'id': 16, 'name': 'Resolve Eliminations and Rewards'}}}, 13: {'name': 'Apply Mass Damage and Downs', 'description': 'Apply damage from mass attacks to all unresolved players and mark any at 0 health.', 'actions': [{'description': 'Clear UI and apply mass damage; mark players at 0 health as downed pending last-chance recovery', 'tools': ['clear_ui', 'apply_mass_damage_and_mark_downs']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Mass damage applied and downed players identified.'}, 'next_phase': {"If any downed players are eligible for last-chance recovery (e.g., 'Beer')": {'id': 15, 'name': 'Last-Chance Recovery Reaction'}, 'Otherwise, proceed to elimination resolution': {'id': 16, 'name': 'Resolve Eliminations and Rewards'}}}, 14: {'name': 'Discard Phase', 'description': "If the current player's hand exceeds their health, they must discard down to their hand limit; then end their turn.", 'actions': [{'description': 'Clear UI and prompt the current player to choose discards until hand size <= health, then confirm end of turn', 'tools': ['clear_ui', 'prompt_discard_to_limit', 'mark_turn_ending_true']}], 'completion_criteria': {'type': 'player_action', 'description': 'Discard choices confirmed and turn-ending state flagged; relevant player state (player_states) has been updated.', 'wait_for': 'single_player_choice', 'target_players': {'description': 'The current player whose turn is ending', 'condition': 'player.id == state.current_player_id and player.is_alive == true'}}, 'next_phase': {'id': 17, 'name': 'Check Win Conditions'}}, 15: {'name': 'Last-Chance Recovery Reaction', 'description': "Downed players at 0 health may immediately respond with allowed recovery (e.g., playing 'Beer' if permitted).", 'actions': [{'description': 'Clear UI and prompt each eligible downed player to play recovery or pass', 'tools': ['clear_ui', 'prompt_last_chance_recovery', 'process_last_chance_recovery']}], 'completion_criteria': {'type': 'player_action', 'description': 'Recovery responses from all eligible downed players have been received, and relevant player state (player_states) has been updated.', 'wait_for': 'multiple_players_action', 'target_players': {'description': 'All players at 0 health who are eligible to attempt recovery', 'condition': 'player.is_alive == true and player.health <= 0 and player.has_emergency_heal_option == true'}}, 'next_phase': {'id': 16, 'name': 'Resolve Eliminations and Rewards'}}, 16: {'name': 'Resolve Eliminations and Rewards', 'description': 'Eliminate any players still at 0 health, reveal their roles, and handle rewards/penalties (e.g., draw rewards for eliminating Outlaws).', 'actions': [{'description': 'Clear UI; eliminate unrecovered players, reveal roles, and award/penalize per rules (e.g., 3-card reward for eliminating Outlaw)', 'tools': ['clear_ui', 'resolve_eliminations_and_rewards', 'reveal_roles_on_elimination', 'award_outlaw_bounties']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Eliminations resolved and state updated.'}, 'next_phase': {'id': 17, 'name': 'Check Win Conditions'}}, 17: {'name': 'Check Win Conditions', 'description': 'Evaluate victory conditions for Sheriff team, Outlaws, or Renegade; otherwise continue the game flow.', 'actions': [{'description': 'Clear UI and evaluate counts/conditions; set win state if met', 'tools': ['clear_ui', 'check_and_set_win_state']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Win condition evaluation finished; state prepared for routing.'}, 'next_phase': {'If no Outlaws and no Renegade remain alive (or only Sheriff team remains)': {'id': 99, 'name': 'Game Over — Sheriff/Deputies Win'}, 'If the Sheriff is dead and more than one player remains (Outlaws still alive)': {'id': 98, 'name': 'Game Over — Outlaws Win'}, 'If exactly one player remains alive and that player is the Renegade': {'id': 97, 'name': 'Game Over — Renegade Wins'}, "If the current player's turn has not ended (turn_ending flag is false)": {'id': 7, 'name': 'Action Phase — Choose and Play a Card or End Turn'}, 'Otherwise (turn has ended or was skipped)': {'id': 18, 'name': 'Advance Turn'}}}, 18: {'name': 'Advance Turn', 'description': "Prepare for the next player's turn by clearing turn flags, recomputing distances if needed, and moving the turn pointer.", 'actions': [{'description': 'Clear UI, reset per-turn limits (e.g., bang_limit_used), clear turn_ending flag, and recompute distances', 'tools': ['clear_ui', 'reset_per_turn_limits', 'clear_turn_ending_flag', 'compute_distances']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Next turn prepared.'}, 'next_phase': {'id': 4, 'name': 'Start Turn — Announce Current Player'}}, 97: {'name': 'Game Over — Renegade Wins', 'description': 'Announce that the Renegade is the last player standing and wins the game.', 'actions': [{'description': 'Clear UI and display Renegade victory message and final standings', 'tools': ['clear_ui', 'display_game_over_screen']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Game over screen displayed.'}, 'next_phase': None}, 98: {'name': 'Game Over — Outlaws Win', 'description': 'Announce that the Sheriff has been eliminated while Outlaws remain; Outlaws win.', 'actions': [{'description': 'Clear UI and display Outlaws victory message and final standings', 'tools': ['clear_ui', 'display_game_over_screen']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Game over screen displayed.'}, 'next_phase': None}, 99: {'name': 'Game Over — Sheriff/Deputies Win', 'description': 'Announce that all Outlaws and the Renegade have been eliminated; Sheriff team wins.', 'actions': [{'description': 'Clear UI and display Sheriff/Deputies victory message and final standings', 'tools': ['clear_ui', 'display_game_over_screen']}], 'completion_criteria': {'type': 'UI_displayed', 'description': 'Game over screen displayed.'}, 'next_phase': None}}}, 'game_description': 'A Wild West shootout card game where players have hidden roles and use playing cards to attack, defend, and survive. The Sheriff (revealed) must eliminate Outlaws and the Renegade. Deputies protect the Sheriff. Outlaws try to kill the Sheriff. The Renegade wants to be the last one standing. Players sit in a circle with distance determining who can be targeted by various cards.\\n\\nGame Flow Navigation: game_setup → role_assignment → character_assignment → initial_setup → turn_start → draw_phase → play_phase → (reaction windows for cards like Bang!/Missed!) → damage_resolution → discard_phase → elimination_check → (check win conditions) → turn_start OR game_over. Each turn consists of drawing 2 cards and playing cards from hand.\\n\\nRole Victory Conditions: Sheriff wins if all Outlaws and Renegade eliminated. Outlaws win if Sheriff eliminated (even if they\'re dead). Deputies win if Sheriff wins. Renegade wins if they\'re the last player alive. Sheriff is always revealed, other roles stay hidden until eliminated.\\n\\nDistance and Range: Players sit in a circle. Distance = shortest path between players (clockwise or counter-clockwise). Base range for Bang! is 1 (adjacent players only). Weapons increase Bang! range. Some cards (Panic!, Cat Balou) have fixed range 1. Distance affects strategic positioning and alliances.\\n\\nCard Types: Playing cards include Bang! (attack), Missed! (defense), Beer (heal), Panic!/Cat Balou (steal/discard), Duel (force showdown), Indians!/Gatling (area attacks), Weapons (increase range), and other equipment. Each character has unique abilities that modify rules (e.g., Rose Doolan sees everyone at distance -1).\\n\\nReaction System: When attacked with Bang!, target can play Missed! to avoid damage. Indians! requires all players to discard Bang! or take damage. Duel creates Bang! exchanges until someone can\'t respond. Real-time reaction windows use collectInputs with timeouts."'}
2025-10-13 20:25:59,773 [INFO] DSLAgent: Reading from file path: /home/lee/canvas-with-langgraph-python/games/bang!.yaml
2025-10-13 20:25:59,773 [INFO] DSLAgent: File exists: True
2025-10-13 20:25:59,773 [INFO] DSLAgent: File content before validation (length: 23720):
2025-10-13 20:25:59,773 [INFO] DSLAgent: File content preview: declaration:
  description: 'A Wild West shootout card game of hidden roles, distance, and reaction
    windows. The Sheriff (revealed) must eliminate Outlaws and the Renegade; Deputies
    protect th...
2025-10-13 20:30:30,351 [INFO] DSLAgent: Model response YAML length: 23970
2025-10-13 20:30:30,352 [INFO] DSLAgent: Validated YAML keys: []
2025-10-13 20:30:30,352 [INFO] DSLAgent: Final validated YAML to write (length: 3):
2025-10-13 20:30:30,352 [INFO] DSLAgent: Final YAML preview: {}
...
2025-10-13 20:30:30,353 [INFO] DSLAgent: Final verification - file content (length: 3):
2025-10-13 20:30:30,353 [INFO] DSLAgent: Final content preview: {}
...
2025-10-13 20:30:30,353 [INFO] DSLAgent: === VALIDATION NODE END ===
