# Backend Agent Architectures

项目探索了三种不同的Agent架构方向，目前效果最好的是Multi-Node架构（`dm_agent_with_bot.py`）。

## 探索的三种架构方向

### 1. Auto-Loop架构 (`agent.py`)

**设计理念**: 基于计划的连续自主执行

**结构图**:
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Entry Point   │────▶│   Chat Node     │────▶│   Tool Node     │
│                 │     │  (Plan & Loop)  │     │ (Backend Tools) │
└─────────────────┘     └─────────┬───────┘     └─────────┬───────┘
                                  │                       │
                                  ▼                       │
                        ┌─────────────────┐               │
                        │   Frontend      │◄──────────────┘
                        │   Tool Calls    │
                        └─────────────────┘
                                  │
                                  ▼
                        ┌─────────────────┐
                        │   Auto-Loop     │
                        │   Continue      │
                        └─────────────────┘
```

**特点**:
- 单一聊天节点处理所有逻辑
- 计划管理系统（planSteps, currentStepIndex, planStatus）
- 自动循环执行直到计划完成
- 适合复杂的多步骤游戏场景

**优势**: 自主性强，进度跟踪详细
**劣势**: Token消耗高，可能出现无限循环

### 2. ReWoo架构 (`agent_no_loop.py`)

**设计理念**: 分离式规划和执行阶段

**结构图**:
```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│   Entry Point   │────▶│ Phase Evaluator │────▶│ Action Executor │
│                 │     │  (Planning)     │     │  (Execution)    │
└─────────────────┘     └─────────┬───────┘     └─────────┬───────┘
                                  │                       │
                                  ▼                       │
                        ┌─────────────────┐               │
                        │ Phase Complete? │               │
                        │ ┌─────┐ ┌─────┐ │               │
                        │ │ Yes │ │ No  │ │               │
                        │ └──┬──┘ └──┬──┘ │               │
                        └────┼──────┼────┘               │
                             │      └─────────────────────┘
                             ▼
                   ┌─────────────────┐
                   │  Next Phase     │
                   │  Transition     │
                   └─────────────────┘
```

**特点**:
- 阶段评估器：分析游戏状态，判断阶段完成度
- 动作执行器：执行预定义的动作列表
- JSON结构化通信
- 明确的阶段转换逻辑

**JSON响应格式**:
```json
{
  "transition": false,
  "note": "等待所有玩家投票",
  "actions": [
    {
      "description": "为存活玩家创建投票面板",
      "tools": ["createVotingPanel", "createTimer"]
    }
  ],
  "player_states_updates": {
    "1": {"name": "Alice", "vote": "Bob"},
    "2": {"name": "Bob", "vote": "Charlie"}
  }
}
```

**优势**: 清晰的职责分离，Token使用高效
**劣势**: 自主性较低，需要精确的DSL定义

### 3. Multi-Node专家架构 (`dm_agent_with_bot.py`) ⭐ **目前效果最好**

**设计理念**: 专业化节点处理不同游戏职责的复杂路由系统

**结构图**:
```
                        ┌─────────────────┐
                        │   Entry Point   │
                        └─────────┬───────┘
                                  │
                                  ▼
                        ┌─────────────────┐
                        │ Initial Router  │◄──┐
                        │     Node        │   │
                        └─────┬─────┬─────┘   │
                              │     │         │
                    ┌─────────┘     │         │
                    │               │         │
                    ▼               ▼         │
          ┌─────────────────┐ ┌─────────────────┐
          │   Chat Bot      │ │ Feedback        │
          │     Node        │ │ Decision Node   │
          └─────────────────┘ └─────┬─────┬─────┘
                    │                     │     │
                    │                     ▼     ▼
                    │           ┌─────────────────┐ ┌─────────────────┐
                    │           │ Bot Behavior    │ │   Phase Node    │
                    │           │     Node        │ └─────────┬───────┘
                    │           └─────────┬───────┘           │
                    │                     │                   ▼
                    │                     ▼         ┌─────────────────┐
                    │           ┌─────────────────┐ │ Role Assignment │
                    │           │  Referee Node   │ │     Node        │
                    │           └─────────┬───────┘ └─────────┬───────┘
                    │                     │                   │
                    │                     └─────────┐         ▼
                    │                               │ ┌─────────────────┐
                    │                               └▶│ Action Executor │
                    │                                 └─────────┬───────┘
                    │                                           │
                    └───────────────────────────────────────────┘
                                                          
                        (所有节点都可能路由到 END)
```

**专业化节点功能**:
- **InitialRouterNode**: 基于游戏状态确定入口点
- **ChatBotNode**: 处理对话AI和玩家交互
- **RoleAssignmentNode**: 管理角色分配
- **PhaseNode**: 控制游戏阶段转换和逻辑
- **BotBehaviorNode**: 模拟AI玩家行为和决策
- **RefereeNode**: 验证游戏规则和解决冲突
- **ActionExecutor**: 执行UI和游戏状态修改
- **ActionValidatorNode**: 验证动作合法性和一致性

**核心特性**:
- **智能路由**: 基于游戏上下文的动态流程控制
- **专业化处理**: 每个节点处理特定的游戏方面
- **Bot集成**: 专门的Bot行为模拟和聊天功能
- **验证管道**: 多层游戏完整性验证
- **反馈系统**: Human-in-the-Loop集成点

**实际执行流程**:
1. **InitialRouterNode** (入口点)
   - 检查是否有聊天消息 → 路由到 **ChatBotNode**
   - 否则路由到 **FeedbackDecisionNode**

2. **ChatBotNode** (聊天处理)
   - 处理玩家聊天交互
   - 结束到 **END** (返回前端)

3. **FeedbackDecisionNode** (反馈决策)
   - 判断玩家是否需要反馈
   - 需要反馈 → 路由到 **BotBehaviorNode**
   - 不需要反馈 → 路由到 **PhaseNode**

4. **BotBehaviorNode** (Bot行为模拟)
   - 模拟AI玩家行为和决策
   - 路由到 **RefereeNode**

5. **RefereeNode** (裁判验证)
   - 验证游戏规则和状态
   - 路由到 **PhaseNode**

6. **PhaseNode** (阶段控制)
   - 分析当前阶段状态
   - 路由到 **RoleAssignmentNode**

7. **RoleAssignmentNode** (角色分配)
   - 处理角色分配逻辑
   - 路由到 **ActionExecutor**

8. **ActionExecutor** (动作执行)
   - 执行UI创建和游戏状态更新
   - 结束到 **END** (返回前端)

**关键路由特点**:
- 大部分节点最终都会到达 **ActionExecutor**
- **ChatBotNode** 是独立的聊天处理分支
- **ActionExecutor** 是主要的UI渲染和状态更新节点
- 系统通过明确的路由链确保游戏逻辑的顺序执行

**为什么效果最好**:
- **高度模块化**: 易于维护和扩展
- **专业化优化**: 每个游戏方面都有针对性优化
- **先进的Bot建模**: 复杂的AI玩家行为
- **全面的验证**: 错误处理和规则执行
- **支持复杂多人交互**: 处理复杂的游戏场景

## 当前生产配置

目前系统使用 **Multi-Node专家架构**，这个选择优化了以下方面：
- **复杂游戏支持**: 处理复杂的多人游戏场景
- **Bot智能**: 先进的AI玩家模拟
- **验证健壮性**: 多层规则执行
- **可扩展性**: 轻松添加新的游戏机制

## 架构选择总结

经过三个方向的探索，**Multi-Node架构在实际游戏运行中表现最佳**：
- 能够处理复杂的多人游戏逻辑
- Bot行为更加智能和自然
- 系统稳定性和可靠性更高
- 为未来功能扩展提供了良好的基础

所有三种架构都保持了：
- **DSL驱动逻辑**: 游戏规则在YAML文件中外部定义
- **CopilotKit集成**: 与前端的双向状态同步
- **工具调用框架**: UI和状态操作的统一接口
- **通用状态管理**: 可在不同游戏类型间重用